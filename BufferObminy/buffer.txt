import com.sun.net.httpserver.HttpServer;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpExchange;

import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.NetworkInterface;
import java.net.InetAddress;
import java.util.Collections;
import java.util.Enumeration;

public class Main {
    public static void main(String[] args) throws Exception {
        int port = 8000;
        HttpServer server = HttpServer.create(new InetSocketAddress("0.0.0.0", port), 0);
        
        server.createContext("/", new HtmlHandler());
        server.setExecutor(null); // Використовує стандартний пул потоків
        server.start();

        System.out.println("Сервер запущено! До нього можна підключитись за адресами:");

        for (String ip : getLocalIPs()) {
            System.out.println("  ➤ http://" + ip + ":" + port + "/");
        }
    }

    // Обробник, який повертає HTML-сторінку
    static class HtmlHandler implements HttpHandler {
        public void handle(HttpExchange exchange) {
            try {
                String response = """
                        <!DOCTYPE html>
                        <html lang="uk">
                        <head>
                            <meta charset="UTF-8">
                            <title>Мій HTTP сервер</title>
                        </head>
                        <body>
                            <h1>Привіт із Java-сервера!</h1>
                            <p>Це базова HTML-сторінка, яку повертає твій HTTP-сервер.</p>
                        </body>
                        </html>
                        """;

                exchange.getResponseHeaders().set("Content-Type", "text/html; charset=UTF-8");
                exchange.sendResponseHeaders(200, response.getBytes().length);
                OutputStream os = exchange.getResponseBody();
                os.write(response.getBytes());
                os.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // Збирає всі локальні IPv4 адреси (крім loopback)
    public static java.util.List<String> getLocalIPs() {
        try {
            java.util.List<String> ipList = new java.util.ArrayList<>();
            Enumeration<NetworkInterface> nets = NetworkInterface.getNetworkInterfaces();
            for (NetworkInterface netint : Collections.list(nets)) {
                if (!netint.isUp() || netint.isLoopback()) continue;
                Enumeration<InetAddress> inetAddresses = netint.getInetAddresses();
                for (InetAddress inetAddress : Collections.list(inetAddresses)) {
                    if (!inetAddress.isLoopbackAddress() && inetAddress instanceof java.net.Inet4Address) {
                        ipList.add(inetAddress.getHostAddress());
                    }
                }
            }
            return ipList;
        } catch (Exception e) {
            e.printStackTrace();
            return java.util.List.of("localhost");
        }
    }
}
